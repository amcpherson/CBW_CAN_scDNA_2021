<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 DLP Sequencing of an Ovarian Cancer Cell Line | Single Cell DNA Analysis Lab</title>
  <meta name="description" content="This is the lab practical for a module on single cell DNA analysis for the CBW Cancer Analysis Workshop" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 DLP Sequencing of an Ovarian Cancer Cell Line | Single Cell DNA Analysis Lab" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the lab practical for a module on single cell DNA analysis for the CBW Cancer Analysis Workshop" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 DLP Sequencing of an Ovarian Cancer Cell Line | Single Cell DNA Analysis Lab" />
  
  <meta name="twitter:description" content="This is the lab practical for a module on single cell DNA analysis for the CBW Cancer Analysis Workshop" />
  

<meta name="author" content="Andrew McPherson" />


<meta name="date" content="2021-06-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="targeted-snv-sequencing-of-an-all-sample.html"/>
<script src="libs/jquery-3.5.1/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.18/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize-0.12.0/selectize.min.js"></script>
<link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Single Cell DNA Analysis Lab</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Lab Overview</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#instructions"><i class="fa fa-check"></i><b>1.1</b> Instructions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><i class="fa fa-check"></i><b>2</b> DLP Sequencing of an Ovarian Cancer Cell Line</a><ul>
<li class="chapter" data-level="2.1" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#load-the-required-packages"><i class="fa fa-check"></i><b>2.2</b> Load the required packages</a></li>
<li class="chapter" data-level="2.3" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#read-and-qc-the-copy-number-data"><i class="fa fa-check"></i><b>2.3</b> Read and QC the copy number data</a></li>
<li class="chapter" data-level="2.4" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#copy-number-exploration"><i class="fa fa-check"></i><b>2.4</b> Copy number exploration</a></li>
<li class="chapter" data-level="2.5" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#clustering"><i class="fa fa-check"></i><b>2.5</b> Clustering</a></li>
<li class="chapter" data-level="2.6" data-path="dlp-sequencing-of-an-ovarian-cancer-cell-line.html"><a href="dlp-sequencing-of-an-ovarian-cancer-cell-line.html#subclonal-gene-amplification"><i class="fa fa-check"></i><b>2.6</b> Subclonal Gene Amplification</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html"><i class="fa fa-check"></i><b>3</b> Targeted SNV Sequencing of an ALL Sample</a><ul>
<li class="chapter" data-level="3.1" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#load-the-required-packages-1"><i class="fa fa-check"></i><b>3.2</b> Load the required packages</a></li>
<li class="chapter" data-level="3.3" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#read-the-data"><i class="fa fa-check"></i><b>3.3</b> Read the data</a></li>
<li class="chapter" data-level="3.4" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#data-qc"><i class="fa fa-check"></i><b>3.4</b> Data QC</a></li>
<li class="chapter" data-level="3.5" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#heatmap-plots"><i class="fa fa-check"></i><b>3.5</b> Heatmap plots</a></li>
<li class="chapter" data-level="3.6" data-path="targeted-snv-sequencing-of-an-all-sample.html"><a href="targeted-snv-sequencing-of-an-all-sample.html#sciφ-phylogeny"><i class="fa fa-check"></i><b>3.6</b> SCIΦ Phylogeny</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Single Cell DNA Analysis Lab</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dlp-sequencing-of-an-ovarian-cancer-cell-line" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> DLP Sequencing of an Ovarian Cancer Cell Line</h1>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">2.1</span> Introduction</h2>
<p>In this tutorial we will analyze the OV2295 cell line DLP data from the paper “Clonal Decomposition and DNA Replication States Defined by Scaled Single-Cell Genome Sequencing”, Laks et al. (2019) <a href="https://doi.org/10.1016/j.cell.2019.10.026" class="uri">https://doi.org/10.1016/j.cell.2019.10.026</a>. The OV2295 cell lines were generated from a primary, metastasis and relapse specimens obtained from a patient with high grade serous ovarian cancer (see Létourneau et al. (2012), <a href="https://doi.org/10.1186/1471-2407-12-379" class="uri">https://doi.org/10.1186/1471-2407-12-379</a>). The cell lines have a high degree of genomic instability, and significant genomic heterogeneity including with respect to large chromosomal changes. The data from the Laks et al. paper is deposited in zenodo (<a href="https://doi.org/10.5281/zenodo.3445364" class="uri">https://doi.org/10.5281/zenodo.3445364</a>).</p>
</div>
<div id="load-the-required-packages" class="section level2">
<h2><span class="header-section-number">2.2</span> Load the required packages</h2>
<p>This tutorial will rely heavily on the <a href="https://www.tidyverse.org/">tidyverse</a> packages including <a href="https://ggplot2.tidyverse.org/">ggplot2</a>. Heatmap plotting will use <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/">ComplexHeatmap</a> and manipulation of genomic segment data will be done with <a href="https://bioconductor.org/packages/release/bioc/vignettes/GenomicRanges/inst/doc/GenomicRangesIntroduction.html">GenomicRanges</a>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">library</span>(vroom)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">library</span>(ggExtra)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">library</span>(grid)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">library</span>(factoextra)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">library</span>(igraph)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">library</span>(bluster)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">library</span>(ggbeeswarm)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">library</span>(umap)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">library</span>(cluster)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">library</span>(Homo.sapiens)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">library</span>(ggpubr)</a></code></pre></div>
</div>
<div id="read-and-qc-the-copy-number-data" class="section level2">
<h2><span class="header-section-number">2.3</span> Read and QC the copy number data</h2>
<p>This data is available from zenodo and can be downloaded with:
<code>wget &quot;https://zenodo.org/record/3445364/files/ov2295_cell_cn.csv.gz&quot;</code>
<code>wget &quot;https://zenodo.org/record/3445364/files/ov2295_cell_metrics.csv.gz&quot;</code></p>
<p>The data was analyzed using the DLP single_cell_pipeline: <a href="https://github.com/shahcompbio/single_cell_pipeline" class="uri">https://github.com/shahcompbio/single_cell_pipeline</a>.</p>
<p>We will first read the metrics data, assess the quality of the cells and filter where necessary. The metrics file provided by the many columns but we will focus on quality and total_reads for filtering. Quality is calculated using a classifier trained on manually curated cell quality calls and uses many of the other metrics as features.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">metrics &lt;-<span class="st"> </span><span class="kw">vroom</span>(<span class="st">&quot;ov2295_cell_metrics.csv.gz&quot;</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">DT<span class="op">::</span><span class="kw">datatable</span>(</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="kw">head</span>(metrics),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="dt">filter =</span> <span class="st">&#39;top&#39;</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="dt">options =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="dt">pageLength=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="dt">scrollX=</span><span class="st">&#39;400px&#39;</span>,</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    <span class="dt">autoWidth=</span><span class="ot">TRUE</span>))</a></code></pre></div>
<div id="htmlwidget-e5dc61656124a0847d0c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e5dc61656124a0847d0c">{"x":{"filter":"top","filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1054\" data-max=\"113421\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"5605\" data-max=\"5554326\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"25\" data-max=\"44742\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"70\" data-max=\"1636879\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"352397\" data-max=\"1469497\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.0280775785117\" data-max=\"0.297331874423\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"235789\" data-max=\"7488663\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"608326\" data-max=\"12127852\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"12323\" data-max=\"11222074\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"338\" data-max=\"3318500\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"8186\" data-max=\"8881854\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.000338684377527\" data-max=\"0.213167407489\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.00034\" data-max=\"0.248342\" data-scale=\"6\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"164\" data-max=\"280\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"186.486199\" data-max=\"341.879476\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"97.249687\" data-max=\"227.675035\" data-scale=\"6\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"3\" data-max=\"70\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"3\" data-max=\"70\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"28\" data-max=\"34\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1\" data-max=\"6\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"2.91313e-08\" data-max=\"0.211090456362805\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1.08087643e-07\" data-max=\"0.500000015170092\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1.885862e-09\" data-max=\"0.500000026957363\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.089795241992086\" data-max=\"0.944122047743692\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.416110943018762\" data-max=\"0.583682622690966\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1.70424639e-07\" data-max=\"0.999999917740242\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"3.29406068431246\" data-max=\"1297.33227196104\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"2\" data-max=\"1269\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1.70140312440384\" data-max=\"535.70606433388\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"10205\" data-max=\"6926457\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1610.83801133142\" data-max=\"15748.8571665562\" data-scale=\"12\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"308.383316381494\" data-max=\"2191.19652279417\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.070187788634716\" data-max=\"0.624999975442537\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.224699038637134\" data-max=\"2.07330259643021\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"3.6722094e-08\" data-max=\"0.499999989212775\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"93\" data-max=\"3099\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"2.38744009962361\" data-max=\"6.90237837044224\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"2\" data-max=\"11\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"-10197.6165058745\" data-max=\"1333.17682233285\" data-scale=\"12\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1.00000003308881\" data-max=\"5.9419088769934\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0\" data-max=\"0.984\" data-scale=\"3\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"64\" data-max=\"572\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6"],["SA922-A90554B-R34-C70","SA922-A90554B-R28-C09","SA922-A90554B-R28-C03","SA922-A90554B-R28-C07","SA922-A90554B-R28-C05","SA922-A90554B-R34-C05"],[70068,49767,1113,113421,1054,1545],[2462814,2723310,5605,5554326,20043,30598],[19418,19848,198,44742,25,171],[711792,701345,70,1636879,608,1752],[352397,588432,1261949,905778,567186,1469497],[0.290496459352,0.260503126872,0.0280775785117,0.297331874423,0.0319154107924,0.0604867630417],[3404765,4353052,235789,7488663,343193,265305],[5348094,6084820,1274272,12127852,608326,1532238],[4995697,5496388,12323,11222074,41140,62741],[1443002,1422538,338,3318500,1241,3675],[4176586,3688510,8186,8881854,30718,45520],[0.108653461872,0.0976288050338,0.000338684377527,0.213167407489,0.00120446690813,0.00173658463471],[0.119764,0.106832,0.00034,0.248342,0.001213,0.001752],[280,164,213,221,217,204],[341.879476,186.486199,255.181199,261.879068,264.571443,244.368131],[227.675035,97.249687,159.275878,160.730523,172.261424,152.670328],["GCTGTA-ATTATA","TAAGGC-TATCGT","GTCCTT-TATCGT","TTGCGG-TATCGT","TAGGAT-TATCGT","TAGGAT-ATTATA"],[70,9,3,7,5,5],[3,64,70,66,68,68],["i5-34","i5-28","i5-28","i5-28","i5-28","i5-34"],["C","C","C","C","C","C"],["GCTGTA","TAAGGC","GTCCTT","TTGCGG","TAGGAT","TAGGAT"],["A","A","NTC","A","NCC","NCC"],["i7-70","i7-09","i7-03","i7-07","i7-05","i7-05"],["C1","C1","C1","C1","C1","C1"],["SA922","SA922","SA922","SA922","SA922","SA922"],["ATTATA","TATCGT","TATCGT","TATCGT","TATCGT","ATTATA"],[34,28,28,28,28,34],["A90554B","A90554B","A90554B","A90554B","A90554B","A90554B"],[0,0,0,0,0,0],[6,5,2,2,2,1],[0.211090456362805,0.12928765748772,1.03312110200093e-07,0.08959941579046,0.0833332618765397,2.91313000388982e-08],[0.443730601612987,0.284760184966217,1.0808764394632e-07,0.220095006546672,0.0833335648196547,0.500000015170091],[0.38820229052076,0.264513500311543,1.88586279925573e-09,0.210668536174778,4.16629308830352e-09,0.500000026957362],[0.910832232414537,0.920953040694805,0.0897952419920864,0.944122047743692,0.308520456042079,0.382953524568451],[0.433665083516754,0.420682738340622,0.516506309859541,0.416110943018763,0.583682622690966,0.560071659918174],[0,0,0,0,0,0],[0.241136875750182,0.210627999736375,1.70424639622802e-07,0.520327779551236,0.999999850570352,0.999999917740242],[580.6168977145,655.46975088968,3.29406068431246,1297.33227196104,6.99959489568564,9.54976030680729],[568,622,2,1269,6,8],[252.079295929584,287.423819175262,1.70140312440384,535.70606433388,4.08554194646329,5.34855011560709],[3099333,3499553,10205,6926457,34557,49802],[7444.15598236322,2189.81575386996,2187.65235944028,1610.83801133142,15748.8571665562,7631.47774544472],[1144.91021894771,423.437858111359,364.82227115743,308.383316381494,1474.23821965957,2191.19652279417],[0.076997335037369,0.0701877886347168,0.0833334265476581,0.133990892078462,0.166666702036063,0.624999975442537],[0.623423233454338,0.361665296164786,0.832407099787669,0.224699038637134,2.07330259643021,1.05559246068464],[0.0411585278652754,0.0413207416925988,3.67220942543156e-08,0.0830381319544842,4.14654741653919e-08,0.499999989212775],[150,93,2136,93,3099,118],[5.46952855524003,4.13257679783462,3.29406069378389,4.11160741822466,6.90237837044224,2.38744009962361],[7,5,2,5,11,2],[-6762.71327286037,-4189.12441397006,1333.17682233285,-2830.59014881121,-10197.6165058745,-8615.34821842351],[5.9419088769934,4.94075876045388,1.9999998476544,2.01312286067933,1.97222285781993,1.00000003308881],[0.482,0.88,0,0.984,0,0.006],[139,572,64,536,185,98]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>cell_id<\/th>\n      <th>unpaired_mapped_reads<\/th>\n      <th>paired_mapped_reads<\/th>\n      <th>unpaired_duplicate_reads<\/th>\n      <th>paired_duplicate_reads<\/th>\n      <th>unmapped_reads<\/th>\n      <th>percent_duplicate_reads<\/th>\n      <th>estimated_library_size<\/th>\n      <th>total_reads<\/th>\n      <th>total_mapped_reads<\/th>\n      <th>total_duplicate_reads<\/th>\n      <th>total_properly_paired<\/th>\n      <th>coverage_breadth<\/th>\n      <th>coverage_depth<\/th>\n      <th>median_insert_size<\/th>\n      <th>mean_insert_size<\/th>\n      <th>standard_deviation_insert_size<\/th>\n      <th>index_sequence<\/th>\n      <th>column<\/th>\n      <th>img_col<\/th>\n      <th>index_i5<\/th>\n      <th>sample_type<\/th>\n      <th>primer_i7<\/th>\n      <th>experimental_condition<\/th>\n      <th>index_i7<\/th>\n      <th>cell_call<\/th>\n      <th>sample_id<\/th>\n      <th>primer_i5<\/th>\n      <th>row<\/th>\n      <th>library_id<\/th>\n      <th>index<\/th>\n      <th>multiplier<\/th>\n      <th>MSRSI_non_integerness<\/th>\n      <th>MBRSI_dispersion_non_integerness<\/th>\n      <th>MBRSM_dispersion<\/th>\n      <th>autocorrelation_hmmcopy<\/th>\n      <th>cv_hmmcopy<\/th>\n      <th>empty_bins_hmmcopy<\/th>\n      <th>mad_hmmcopy<\/th>\n      <th>mean_hmmcopy_reads_per_bin<\/th>\n      <th>median_hmmcopy_reads_per_bin<\/th>\n      <th>std_hmmcopy_reads_per_bin<\/th>\n      <th>total_mapped_reads_hmmcopy<\/th>\n      <th>total_halfiness<\/th>\n      <th>scaled_halfiness<\/th>\n      <th>mean_state_mads<\/th>\n      <th>mean_state_vars<\/th>\n      <th>mad_neutral_state<\/th>\n      <th>breakpoints<\/th>\n      <th>mean_copy<\/th>\n      <th>state_mode<\/th>\n      <th>log_likelihood<\/th>\n      <th>true_multiplier<\/th>\n      <th>quality<\/th>\n      <th>order<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":50,"scrollX":"400px","autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,29,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script>
<p>Plot a scatterplot of quality by total reads with marginals on the axes. The cloud of cells with significant read count and quality less than 0.75 are cells for which we cannot effectively predict copy number. These cells could either be cycling, or for which the genomic DNA degraded significantly prior to sequencing, or for which tagmentation failed.</p>
<p>The plots in this notebook will be using ggplot extensively. I recommend the r4ds tutorials (<a href="https://r4ds.had.co.nz/data-visualisation.html" class="uri">https://r4ds.had.co.nz/data-visualisation.html</a>) and the ggplot cheat sheet (<a href="https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf" class="uri">https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf</a>) for further reference.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">p &lt;-<span class="st"> </span>metrics <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>quality, <span class="dt">y=</span>total_reads)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;left&quot;</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">ggMarginal</span>(p, <span class="dt">type=</span><span class="st">&quot;histogram&quot;</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Filter reads based on a quality threshold of 0.85 and a total read count threshold of 500k reads. Also filter control cells based on the experimental_condition and sample_id columns.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">metrics &lt;-<span class="st"> </span>metrics <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  quality <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.85</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  total_reads <span class="op">&gt;</span><span class="st"> </span><span class="dv">500000</span>,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="op">!</span>(experimental_condition <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;GM&quot;</span>, <span class="st">&quot;gDNA&quot;</span>)),</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  sample_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SA1090&quot;</span>, <span class="st">&quot;SA921&quot;</span>, <span class="st">&quot;SA922&quot;</span>))</a></code></pre></div>
<p>Read in the copy number data. Using vroom::vroom will significantly speed up data loading and using factors for chr and cell_id and ignoring irrelevant columns will reduce the memory footprint.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">cn &lt;-<span class="st"> </span><span class="kw">vroom</span>(</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="st">&#39;ov2295_cell_cn.csv.gz&#39;</span>,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="dt">col_types =</span> <span class="kw">cols</span>(</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="dt">chr =</span> <span class="kw">col_factor</span>(<span class="ot">NULL</span>),</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="dt">cell_id =</span> <span class="kw">col_factor</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  ),</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="dt">col_select =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    chr,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">    start,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    end,</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    reads,</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">    copy,</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    state,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    cell_id</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  )</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">)</a></code></pre></div>
<p>Subset copy number data by the filtered cell ids in the metrics table.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">cn &lt;-<span class="st"> </span>cn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(metrics[, <span class="kw">c</span>(<span class="st">&quot;cell_id&quot;</span>, <span class="st">&quot;sample_id&quot;</span>)], <span class="dt">by =</span> <span class="st">&quot;cell_id&quot;</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(cn), <span class="dt">booktabs =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">chr</th>
<th align="right">start</th>
<th align="right">end</th>
<th align="right">reads</th>
<th align="right">copy</th>
<th align="right">state</th>
<th align="left">cell_id</th>
<th align="left">sample_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">500000</td>
<td align="right">22</td>
<td align="right">NA</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">500001</td>
<td align="right">1000000</td>
<td align="right">609</td>
<td align="right">NA</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="right">1000001</td>
<td align="right">1500000</td>
<td align="right">752</td>
<td align="right">4.574060</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">1500001</td>
<td align="right">2000000</td>
<td align="right">672</td>
<td align="right">3.465685</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="right">2000001</td>
<td align="right">2500000</td>
<td align="right">931</td>
<td align="right">5.571458</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">2500001</td>
<td align="right">3000000</td>
<td align="right">794</td>
<td align="right">NA</td>
<td align="right">5</td>
<td align="left">SA922-A90554B-R28-C09</td>
<td align="left">SA922</td>
</tr>
</tbody>
</table>
</div>
<div id="copy-number-exploration" class="section level2">
<h2><span class="header-section-number">2.4</span> Copy number exploration</h2>
<p>We will plot cells using a scatter plot of normalized binned read count data. The data has been processed through HMMCopy analysis as part of the DLP single cell pipeline. The state column contains the prediction of integer copy number state for each cell. The copy column is raw read count normalized for ploidy, gc, and mappability. We will plot copy on the y axis and color by state, and wrap the plotting code in a function for use below.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">plot_profile &lt;-<span class="st"> </span><span class="cf">function</span>(cn) {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">3</span>, <span class="st">&quot;Blues&quot;</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="st">&quot;#CCCCCC&quot;</span>, <span class="kw">tail</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">8</span>, <span class="st">&quot;OrRd&quot;</span>), <span class="dv">6</span>))</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(cn.colors, cn.colors[<span class="kw">c</span>(<span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>)])</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="kw">names</span>(cn.colors) &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">12</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  cn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">cn_state =</span> <span class="kw">factor</span>(state, <span class="kw">names</span>(cn.colors))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">chr =</span> <span class="kw">factor</span>(chr, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">22</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">    </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="st">      </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> start, <span class="dt">y =</span> copy, <span class="dt">colour =</span> cn_state), <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="st">      </span><span class="kw">facet_grid</span>(<span class="op">~</span>chr, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="dt">space=</span><span class="st">&quot;free_x&quot;</span>, <span class="dt">switch =</span> <span class="st">&quot;x&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="st">      </span><span class="kw">theme</span>(<span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="fl">0.05</span>, <span class="st">&quot;cm&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="st">      </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="st">      </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> cn.colors, <span class="dt">labels =</span> <span class="kw">names</span>(cn.colors), <span class="dt">drop =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="st">      </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="dt">by =</span> <span class="dv">1</span>), <span class="dt">limit =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">8</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="st">      </span><span class="kw">xlab</span>(<span class="st">&#39;chromosome&#39;</span>)</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb9-18" data-line-number="18"></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">plot_cell &lt;-<span class="st"> </span><span class="cf">function</span>(cn, plot_cell_id) {</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">  <span class="kw">filter</span>(cn, cell_id <span class="op">==</span><span class="st"> </span>plot_cell_id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot_profile</span>()</a>
<a class="sourceLine" id="cb9-21" data-line-number="21">}</a></code></pre></div>
<p>The first cell we will plot is a near diploid cell with some amplified regions and many LOH regions including chromosome 17. The chromosome 17 LOH overlaps with a deliterious TP53 mutation, as is typical of high grade serous ovarian cancers.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">plot_cell</span>(cn, <span class="st">&quot;SA1090-A96213A-R30-C61&quot;</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 740 rows containing missing values (geom_point).</code></pre>
<p><img src="book_files/figure-html/unnamed-chunk-10-1.png" width="672" />
A second cell from the same cell line appears to be baseline tetraploid. Many of the amplified or deleted regions overlap with those of the diploid baseline cell. Copy 3 regions on chromosome 2 and 15 support the tetraploid solution.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">plot_cell</span>(cn, <span class="st">&quot;SA1090-A96213A-R28-C68&quot;</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 762 rows containing missing values (geom_point).</code></pre>
<p><img src="book_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>It will be useful to plot all cells together in a heatmap for a high level look at the heterogeneity. Here we rely on the very useful <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/">ComplexHeatmap package</a>. The plot takes a GenomicRanges object with columns as cells and rows as regions. A nice tutorial on GenomicRanges can be found <a href="https://bioconductor.github.io/BiocWorkshops/solving-common-bioinformatic-challenges-using-genomicranges.html">here</a>. The plot will use hierarchical clustering to order the cells and provide a summary of the similarity between groups of cells.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">plot_heatmap &lt;-<span class="st"> </span><span class="cf">function</span>(gr, <span class="dt">dist_method =</span> <span class="st">&quot;euclidean&quot;</span>){</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  <span class="co">#&#39; plot a heatmap with chromosome boundaries</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="co">#&#39; the order of the rows can be customized here</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="co">#&#39; its a simple distance based clustering</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  <span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="co">#&#39; Adapted from code published by Velazquez-Villarreal et al. (2020):</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">  <span class="co">#&#39; https://www.nature.com/articles/s42003-020-1044-8</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  <span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="co">#&#39; Uses the very useful ComplexHeatmap package:</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  <span class="co">#&#39; https://jokergoo.github.io/ComplexHeatmap-reference/book/</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb14-12" data-line-number="12">  gr &lt;-<span class="st"> </span>GenomeInfoDb<span class="op">::</span><span class="kw">sortSeqlevels</span>(gr)</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">  gr &lt;-<span class="st"> </span><span class="kw">sort</span>(gr)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">  mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(gr))</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">  mat &lt;-<span class="st"> </span><span class="kw">t</span>(mat)</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">  hr &lt;-<span class="st"> </span><span class="kw">hclust</span>(<span class="kw">get_dist</span>(mat, <span class="dt">method =</span> dist_method), <span class="dt">method =</span> <span class="st">&quot;average&quot;</span>)</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">  hr =<span class="st"> </span><span class="kw">as.dendrogram</span>(hr)</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb14-20" data-line-number="20">  <span class="co"># chromosome boundaries and midpoints for annotation</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21">  chr_ids =<span class="st"> </span>GenomicRanges<span class="op">::</span><span class="kw">seqnames</span>(gr)<span class="op">@</span>values</a>
<a class="sourceLine" id="cb14-22" data-line-number="22">  chr_lengths =<span class="st"> </span>GenomicRanges<span class="op">::</span><span class="kw">seqnames</span>(gr)<span class="op">@</span>lengths</a>
<a class="sourceLine" id="cb14-23" data-line-number="23">  chr_props =<span class="st"> </span>chr_lengths <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(gr)</a>
<a class="sourceLine" id="cb14-24" data-line-number="24">  mids =<span class="st"> </span><span class="kw">cumsum</span>(chr_props) <span class="op">-</span><span class="st"> </span>(chr_props <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">  boundaries =<span class="st"> </span><span class="kw">cumsum</span>(chr_props)</a>
<a class="sourceLine" id="cb14-26" data-line-number="26">  boundaries =<span class="st"> </span>boundaries[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(boundaries)<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">  abline_x =<span class="st"> </span><span class="kw">rep</span>(boundaries, <span class="dt">each=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb14-28" data-line-number="28">  abline_y &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">times=</span><span class="kw">length</span>(boundaries))</a>
<a class="sourceLine" id="cb14-29" data-line-number="29">  abline_ids &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(boundaries),<span class="dt">each=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb14-30" data-line-number="30"></a>
<a class="sourceLine" id="cb14-31" data-line-number="31">  <span class="co">#annotation to label chromosomes</span></a>
<a class="sourceLine" id="cb14-32" data-line-number="32">  ha_column =<span class="st"> </span>ComplexHeatmap<span class="op">::</span><span class="kw">HeatmapAnnotation</span>(<span class="dt">cn =</span> <span class="cf">function</span>(index) {</a>
<a class="sourceLine" id="cb14-33" data-line-number="33">    <span class="kw">grid.text</span>(chr_ids,<span class="dt">x=</span>mids,<span class="dt">y=</span><span class="dv">1</span>,<span class="dt">just =</span> <span class="kw">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;top&quot;</span>),<span class="dt">gp=</span><span class="kw">gpar</span>(<span class="dt">col=</span><span class="st">&quot;#202020&quot;</span>,<span class="dt">fontsize=</span><span class="dv">6</span>))</a>
<a class="sourceLine" id="cb14-34" data-line-number="34">  })</a>
<a class="sourceLine" id="cb14-35" data-line-number="35">  </a>
<a class="sourceLine" id="cb14-36" data-line-number="36">  <span class="co"># the main heatmap</span></a>
<a class="sourceLine" id="cb14-37" data-line-number="37">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">3</span>, <span class="st">&quot;Blues&quot;</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="st">&quot;#CCCCCC&quot;</span>, <span class="kw">tail</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">8</span>, <span class="st">&quot;OrRd&quot;</span>), <span class="dv">6</span>))</a>
<a class="sourceLine" id="cb14-38" data-line-number="38">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(cn.colors, cn.colors[<span class="kw">c</span>(<span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>)])</a>
<a class="sourceLine" id="cb14-39" data-line-number="39">  <span class="kw">names</span>(cn.colors) &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">12</span></a>
<a class="sourceLine" id="cb14-40" data-line-number="40"></a>
<a class="sourceLine" id="cb14-41" data-line-number="41">  hm &lt;-<span class="st"> </span>ComplexHeatmap<span class="op">::</span><span class="kw">Heatmap</span>(</a>
<a class="sourceLine" id="cb14-42" data-line-number="42">    <span class="dt">matrix =</span> mat,</a>
<a class="sourceLine" id="cb14-43" data-line-number="43">    <span class="dt">name =</span> <span class="st">&quot;ploidy&quot;</span>,</a>
<a class="sourceLine" id="cb14-44" data-line-number="44">    <span class="dt">col =</span> cn.colors,</a>
<a class="sourceLine" id="cb14-45" data-line-number="45">    <span class="dt">cluster_rows =</span> hr,</a>
<a class="sourceLine" id="cb14-46" data-line-number="46">    <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb14-47" data-line-number="47">    <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb14-48" data-line-number="48">    <span class="dt">bottom_annotation =</span> ha_column,</a>
<a class="sourceLine" id="cb14-49" data-line-number="49">    <span class="dt">column_title =</span> <span class="st">&quot;CNV heatmap&quot;</span>,</a>
<a class="sourceLine" id="cb14-50" data-line-number="50">    <span class="dt">use_raster =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb14-51" data-line-number="51">  )</a>
<a class="sourceLine" id="cb14-52" data-line-number="52">  </a>
<a class="sourceLine" id="cb14-53" data-line-number="53">  ComplexHeatmap<span class="op">::</span><span class="kw">draw</span>(hm, <span class="dt">row_dend_side =</span> <span class="st">&quot;left&quot;</span>)</a>
<a class="sourceLine" id="cb14-54" data-line-number="54"></a>
<a class="sourceLine" id="cb14-55" data-line-number="55">  ComplexHeatmap<span class="op">::</span><span class="kw">decorate_heatmap_body</span>(<span class="st">&quot;ploidy&quot;</span>, {</a>
<a class="sourceLine" id="cb14-56" data-line-number="56">    <span class="kw">grid.polyline</span>(</a>
<a class="sourceLine" id="cb14-57" data-line-number="57">      <span class="dt">x =</span> abline_x,</a>
<a class="sourceLine" id="cb14-58" data-line-number="58">      <span class="dt">y =</span> abline_y,</a>
<a class="sourceLine" id="cb14-59" data-line-number="59">      <span class="dt">id =</span> abline_ids,</a>
<a class="sourceLine" id="cb14-60" data-line-number="60">      <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">lwd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb14-61" data-line-number="61">  })</a>
<a class="sourceLine" id="cb14-62" data-line-number="62">}</a></code></pre></div>
<p>Plotting SA1090 (the primary sample), we can see that there are two major groups, a baseline diploid and a baseline tetraploid group. Both groups harbour additional heterogeneity. Looking closely, it appears that many of the patterns that distinguish populations within the diploid group are also found in the tetraploid group.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">gr &lt;-<span class="st"> </span>cn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(sample_id <span class="op">==</span><span class="st"> &quot;SA1090&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(chr, start, end, state, cell_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> cell_id, <span class="dt">values_from =</span> state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span>GenomicRanges<span class="op">::</span><span class="kw">makeGRangesFromDataFrame</span>(<span class="dt">keep.extra.columns=</span><span class="ot">TRUE</span>,<span class="dt">ignore.strand=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="kw">plot_heatmap</span>(gr)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>The default distance method for generating the hierarchical clustering was eucldean, which will naturally result in large distances between diploid and tetraploid cells. Alternative distance methods can be specified, see the get_dist function from <a href="https://www.rdocumentation.org/packages/factoextra/versions/1.0.7/topics/dist">factoextras</a>. If we use pearson correlation as the distance method, we see significant mixing of the diploid and tetraploid populations indicating that tetraploidization is occuring independently and sporadically throughout the population.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">plot_heatmap</span>(gr, <span class="dt">dist_method =</span> <span class="st">&quot;pearson&quot;</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>If we plot total_reads by mean_copy (average ploidy) there appears to be a relationship, likely due to the fact that tetraploid cells will have twice the DNA available and take up more sequencing realestate. Classifying diploid and tetraploid, the difference in mean total_reads is highly significant, further evidence the tetraploid cells are truly tetraploid. Some cells classified as diploid may in fact be tetraploid with a perfect doubling of all chromosomes though this would be difficult to determine without orthogonal experiments. Note that we havent ruled out doublets with certainty.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">metrics <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(sample_id <span class="op">==</span><span class="st"> &quot;SA1090&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>mean_copy, <span class="dt">y=</span>total_reads)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method=</span><span class="st">&#39;lm&#39;</span>, <span class="dt">formula=</span> y<span class="op">~</span>x)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">metrics <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(sample_id <span class="op">==</span><span class="st"> &quot;SA1090&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">is_polyploid =</span> mean_copy <span class="op">&gt;</span><span class="st"> </span><span class="fl">2.5</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>is_polyploid, <span class="dt">y=</span>total_reads)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="st">    </span><span class="kw">stat_compare_means</span>(<span class="dt">label.x =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
</div>
<div id="clustering" class="section level2">
<h2><span class="header-section-number">2.5</span> Clustering</h2>
<p>In order to further understand the population structure we can cluster the cells by their copy number profiles. It is worth noting that for some datasets, clustering is inappropriate. If the population of cells is continuously evolving and accruing neutral copy number changes, the cells will lie on a continuum of copy number change. Any maximal set of related cells could be considered a ‘cluster’ if a copy number change exists specific to that set of cells. In such a case phylogenetic representation is more appropriate. However, in many real datasets sets of cells will cluster due to either selection having favoured the expansion of some cell populations and the extinction of others.</p>
<p>We will first cluster the cells using k-means. Independent segmentation of each cell using HMMCopy can produce small differences in segment boundaries that may affect clustering. We will thus cluster based on the raw copy number (‘copy’ column) instead of the HMMCopy state. Start by creating a matrix of raw copy number values, filtering bins with NaNs in any cell and scaling the data to allow clustering of cells with dissimilar ploidy.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">gr &lt;-<span class="st"> </span>cn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(chr, start, end, copy, cell_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> cell_id, <span class="dt">values_from =</span> copy) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">  </span>GenomicRanges<span class="op">::</span><span class="kw">makeGRangesFromDataFrame</span>(<span class="dt">keep.extra.columns=</span><span class="ot">TRUE</span>,<span class="dt">ignore.strand=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="co"># Remove bins with any nan across any cell</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7">gr &lt;-<span class="st"> </span>gr[<span class="kw">complete.cases</span>(GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(gr))]</a>
<a class="sourceLine" id="cb19-8" data-line-number="8"></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co"># Create matrix, remove bins that are nan across any cells</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10">mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(gr))</a>
<a class="sourceLine" id="cb19-11" data-line-number="11"></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="co"># Optionally normalize the copy number, this will group cells regardless of ploidy</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13">mat &lt;-<span class="st"> </span><span class="kw">scale</span>(mat)</a>
<a class="sourceLine" id="cb19-14" data-line-number="14"></a>
<a class="sourceLine" id="cb19-15" data-line-number="15">mat &lt;-<span class="st"> </span><span class="kw">t</span>(mat)</a></code></pre></div>
<p>We will then use PCA to transform the data to a reduced dimensionality representation. In bin level copy number data, many of the bins will be highly correlated especially with neighboring bins subject to the same copy number change. PCA will effectively compress multiple correlated bins into a single dimension. Working with the top PCA components will be desirable because it decreases the computational burden of downstream computation (ie clustering) and reduces noise by averaging across multiple bins. PCA can be run using the <code>prcomp</code> function:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">mat.pca &lt;-<span class="st"> </span><span class="kw">prcomp</span>(mat)</a></code></pre></div>
<p>It can be informative to plot the PCA loadings of the top components. The loadings for a given component represent how much each bin contributes to that component. Large positive or negative values indicate a strong positive or negative correlation of the bin with the component respectively. Values close to 0 indicate the bin is uncorrelated with the component. The PCA loading plot can be helpful in identifying problematic noisy bins. These bins will show up as isolated spikes in the PCA loading plot. The first PCA plotted below looks unproblematic. Try setting the value of a bin to 1000 for a subset of cells and redoing the PCA to see the effect.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">pc =<span class="st"> &quot;PC1&quot;</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">gr.pca &lt;-<span class="st"> </span><span class="kw">granges</span>(gr)</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(gr.pca) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">PC=</span>mat.pca<span class="op">$</span>rotation[, pc])</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"></a>
<a class="sourceLine" id="cb21-6" data-line-number="6">GenomicRanges<span class="op">::</span><span class="kw">as.data.frame</span>(gr.pca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="st">  </span><span class="kw">tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">chr=</span>seqnames) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="st">    </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> start, <span class="dt">y =</span> PC), <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="st">    </span><span class="kw">facet_grid</span>(<span class="op">~</span>chr, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="dt">space=</span><span class="st">&quot;free_x&quot;</span>, <span class="dt">switch =</span> <span class="st">&quot;x&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="fl">0.05</span>, <span class="st">&quot;cm&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&#39;chromosome&#39;</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Now run k-means on the first 50 PCs. Use 12 cluster centers and 100 restarts and set a seed for consistency.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">clust.kmeans &lt;-<span class="st"> </span><span class="kw">kmeans</span>(mat.pca<span class="op">$</span>x[, <span class="dv">1</span><span class="op">:</span><span class="dv">50</span>], <span class="dt">centers=</span><span class="dv">12</span>, <span class="dt">nstart=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">clust &lt;-<span class="st"> </span>clust.kmeans<span class="op">$</span>cluster</a></code></pre></div>
<p>UMAP is a non-linear dimensionality reduction technique favoured for its ability to preserve much of the structure of the data in a 2-D plot. We can use UMAP to visualize the clustering.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">mat.umap &lt;-<span class="st"> </span><span class="kw">umap</span>(mat)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">mat.umap.tbl &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x=</span>mat.umap<span class="op">$</span>layout[,<span class="dv">1</span>], <span class="dt">y=</span>mat.umap<span class="op">$</span>layout[,<span class="dv">2</span>], <span class="dt">cluster=</span><span class="kw">factor</span>(clust))</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="kw">ggplot</span>(mat.umap.tbl) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">color=</span>cluster))</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>We can also assess the clustering using the silhouette method. Briefly, the <a href="https://en.wikipedia.org/wiki/Silhouette_(clustering)">silhouette width statistic</a> is calculated based on the mean distance of a datapoint to every other datapoint in the same cluster, and the mean distance to datapoints in the next closest cluster. A silhouette width less than 0 could indicate the cell may be better assigned to a different cluster, the cell is an outlier, or the data are not spherically distributed around cluster centers.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">sil.approx &lt;-<span class="st"> </span><span class="kw">approxSilhouette</span>(mat, <span class="dt">clusters=</span>clust)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"></a>
<a class="sourceLine" id="cb24-3" data-line-number="3">sil.data &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(sil.approx)</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">sil.data<span class="op">$</span>closest &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">ifelse</span>(sil.data<span class="op">$</span>width <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, clust, sil.data<span class="op">$</span>other))</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">sil.data<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">factor</span>(clust)</a>
<a class="sourceLine" id="cb24-6" data-line-number="6"></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="kw">ggplot</span>(sil.data, <span class="kw">aes</span>(<span class="dt">x=</span>cluster, <span class="dt">y=</span>width, <span class="dt">colour=</span>closest)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="st">    </span>ggbeeswarm<span class="op">::</span><span class="kw">geom_quasirandom</span>(<span class="dt">method=</span><span class="st">&quot;smiley&quot;</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>We used k=12 cluster centers somewhat arbitrarily. Many strategies exist for selecting an appropriate value for k. For instance, we could use the gap statistic to select an optimal k as shown below. The optimal number of clusters suggested by this method may be less than expected reflecting the issues with clustering, especially k-means clustering, on this type of data. Generally speaking, differences between sub-populations will vary widely in scale with some populations well separated by large copy number changes and other derivative populations differing only by a few changes.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">gaps &lt;-<span class="st"> </span><span class="kw">clusGap</span>(mat.pca<span class="op">$</span>x[, <span class="dv">1</span><span class="op">:</span><span class="dv">50</span>], kmeans, <span class="dt">K.max=</span><span class="dv">30</span>, <span class="dt">B=</span><span class="dv">100</span>)</a></code></pre></div>
<pre><code>## Clustering k = 1,2,..., K.max (= 30): .. done
## Bootstrapping, b = 1,2,..., B (= 100)  [one &quot;.&quot; per sample]:
## .................................................. 50 
## .................................................. 100</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">best.k &lt;-<span class="st"> </span><span class="kw">maxSE</span>(gaps<span class="op">$</span>Tab[,<span class="st">&quot;gap&quot;</span>], gaps<span class="op">$</span>Tab[,<span class="st">&quot;SE.sim&quot;</span>])</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">as_tibble</span>(gaps<span class="op">$</span>Tab) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">k=</span><span class="kw">factor</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>k, <span class="dt">y=</span>gap)) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span>best.k, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>, <span class="dt">lty=</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-7" data-line-number="7"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Number of clusters&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Gap statistic&quot;</span>)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Alternative clustering approaches are possible, see <a href="https://bioconductor.org/books/release/OSCA/clustering.html">this excellent scRNA tutorial</a> for ideas. For instance, a graph based clustering approach could work better for clustering copy number data in some cases, as graph based methods will not favour spherical clusters.</p>
<p>In order to visualize the cluster copy number, lets modify our heatmap plotting function to take in a clustering, order the rows by each cell’s cluster label, and annotate the clusters on the left side of the heatmap.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">plot_cluster_heatmap &lt;-<span class="st"> </span><span class="cf">function</span>(gr, clust){</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  <span class="co">#&#39; plot a heatmap with chromosome boundaries</span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3">  <span class="co">#&#39; the order of the rows can be customized here</span></a>
<a class="sourceLine" id="cb28-4" data-line-number="4">  <span class="co">#&#39; its a simple distance based clustering</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5">  <span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6">  <span class="co">#&#39; Adapted from code published by Velazquez-Villarreal et al. (2020):</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">  <span class="co">#&#39; https://www.nature.com/articles/s42003-020-1044-8</span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8">  <span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9">  <span class="co">#&#39; Uses the very useful ComplexHeatmap package:</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10">  <span class="co">#&#39; https://jokergoo.github.io/ComplexHeatmap-reference/book/</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb28-12" data-line-number="12">  gr &lt;-<span class="st"> </span>GenomeInfoDb<span class="op">::</span><span class="kw">sortSeqlevels</span>(gr)</a>
<a class="sourceLine" id="cb28-13" data-line-number="13">  gr &lt;-<span class="st"> </span><span class="kw">sort</span>(gr)</a>
<a class="sourceLine" id="cb28-14" data-line-number="14"></a>
<a class="sourceLine" id="cb28-15" data-line-number="15">  sorted_clust =<span class="st"> </span><span class="kw">sort</span>(clust)</a>
<a class="sourceLine" id="cb28-16" data-line-number="16"></a>
<a class="sourceLine" id="cb28-17" data-line-number="17">  mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(gr))</a>
<a class="sourceLine" id="cb28-18" data-line-number="18">  mat &lt;-<span class="st"> </span><span class="kw">t</span>(mat)</a>
<a class="sourceLine" id="cb28-19" data-line-number="19">  mat &lt;-<span class="st"> </span>mat[<span class="kw">names</span>(sorted_clust),]</a>
<a class="sourceLine" id="cb28-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb28-21" data-line-number="21">  <span class="co"># chromosome boundaries and midpoints for annotation</span></a>
<a class="sourceLine" id="cb28-22" data-line-number="22">  chr_ids =<span class="st"> </span>GenomicRanges<span class="op">::</span><span class="kw">seqnames</span>(gr)<span class="op">@</span>values</a>
<a class="sourceLine" id="cb28-23" data-line-number="23">  chr_lengths =<span class="st"> </span>GenomicRanges<span class="op">::</span><span class="kw">seqnames</span>(gr)<span class="op">@</span>lengths</a>
<a class="sourceLine" id="cb28-24" data-line-number="24">  chr_props =<span class="st"> </span>chr_lengths <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(gr)</a>
<a class="sourceLine" id="cb28-25" data-line-number="25">  mids =<span class="st"> </span><span class="kw">cumsum</span>(chr_props) <span class="op">-</span><span class="st"> </span>(chr_props <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb28-26" data-line-number="26">  boundaries =<span class="st"> </span><span class="kw">cumsum</span>(chr_props)</a>
<a class="sourceLine" id="cb28-27" data-line-number="27">  boundaries =<span class="st"> </span>boundaries[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(boundaries)<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb28-28" data-line-number="28">  abline_x =<span class="st"> </span><span class="kw">rep</span>(boundaries, <span class="dt">each=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb28-29" data-line-number="29">  abline_y &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">times=</span><span class="kw">length</span>(boundaries))</a>
<a class="sourceLine" id="cb28-30" data-line-number="30">  abline_ids &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(boundaries),<span class="dt">each=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb28-31" data-line-number="31"></a>
<a class="sourceLine" id="cb28-32" data-line-number="32">  <span class="co"># annotation to label chromosomes</span></a>
<a class="sourceLine" id="cb28-33" data-line-number="33">  ha_column =<span class="st"> </span>ComplexHeatmap<span class="op">::</span><span class="kw">HeatmapAnnotation</span>(<span class="dt">cn =</span> <span class="cf">function</span>(index) {</a>
<a class="sourceLine" id="cb28-34" data-line-number="34">    <span class="kw">grid.text</span>(chr_ids,<span class="dt">x=</span>mids,<span class="dt">y=</span><span class="dv">1</span>,<span class="dt">just =</span> <span class="kw">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;top&quot;</span>),<span class="dt">gp=</span><span class="kw">gpar</span>(<span class="dt">col=</span><span class="st">&quot;#202020&quot;</span>,<span class="dt">fontsize=</span><span class="dv">6</span>))</a>
<a class="sourceLine" id="cb28-35" data-line-number="35">  })</a>
<a class="sourceLine" id="cb28-36" data-line-number="36"></a>
<a class="sourceLine" id="cb28-37" data-line-number="37">  <span class="co"># cluster annotation</span></a>
<a class="sourceLine" id="cb28-38" data-line-number="38">  cluster_colors =<span class="st"> </span><span class="kw">rainbow</span>(<span class="kw">length</span>(<span class="kw">unique</span>(sorted_clust)))</a>
<a class="sourceLine" id="cb28-39" data-line-number="39">  <span class="kw">names</span>(cluster_colors) =<span class="st"> </span><span class="kw">unique</span>(sorted_clust)</a>
<a class="sourceLine" id="cb28-40" data-line-number="40">  ha_row =<span class="st"> </span>ComplexHeatmap<span class="op">::</span><span class="kw">rowAnnotation</span>(<span class="dt">cluster =</span> <span class="kw">factor</span>(sorted_clust), <span class="dt">col =</span> <span class="kw">list</span>(<span class="dt">cluster =</span> cluster_colors))</a>
<a class="sourceLine" id="cb28-41" data-line-number="41"></a>
<a class="sourceLine" id="cb28-42" data-line-number="42">  <span class="co"># the main heatmap</span></a>
<a class="sourceLine" id="cb28-43" data-line-number="43">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">3</span>, <span class="st">&quot;Blues&quot;</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="st">&quot;#CCCCCC&quot;</span>, <span class="kw">tail</span>(<span class="kw">brewer.pal</span>(<span class="dt">n =</span> <span class="dv">8</span>, <span class="st">&quot;OrRd&quot;</span>), <span class="dv">6</span>))</a>
<a class="sourceLine" id="cb28-44" data-line-number="44">  cn.colors &lt;-<span class="st"> </span><span class="kw">c</span>(cn.colors, cn.colors[<span class="kw">c</span>(<span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>, <span class="dv">9</span>)])</a>
<a class="sourceLine" id="cb28-45" data-line-number="45">  <span class="kw">names</span>(cn.colors) &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">12</span></a>
<a class="sourceLine" id="cb28-46" data-line-number="46"></a>
<a class="sourceLine" id="cb28-47" data-line-number="47">  hm =<span class="st"> </span>ComplexHeatmap<span class="op">::</span><span class="kw">Heatmap</span>(</a>
<a class="sourceLine" id="cb28-48" data-line-number="48">    <span class="dt">matrix =</span> mat,</a>
<a class="sourceLine" id="cb28-49" data-line-number="49">    <span class="dt">name =</span> <span class="st">&quot;ploidy&quot;</span>,</a>
<a class="sourceLine" id="cb28-50" data-line-number="50">    <span class="dt">col =</span> cn.colors,</a>
<a class="sourceLine" id="cb28-51" data-line-number="51">    <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb28-52" data-line-number="52">    <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb28-53" data-line-number="53">    <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb28-54" data-line-number="54">    <span class="dt">bottom_annotation =</span> ha_column,</a>
<a class="sourceLine" id="cb28-55" data-line-number="55">    <span class="dt">left_annotation =</span> ha_row,</a>
<a class="sourceLine" id="cb28-56" data-line-number="56">    <span class="dt">column_title =</span> <span class="st">&quot;CNV heatmap&quot;</span>,</a>
<a class="sourceLine" id="cb28-57" data-line-number="57">    <span class="dt">use_raster =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb28-58" data-line-number="58">  )</a>
<a class="sourceLine" id="cb28-59" data-line-number="59">  </a>
<a class="sourceLine" id="cb28-60" data-line-number="60">  ComplexHeatmap<span class="op">::</span><span class="kw">draw</span>(hm)</a>
<a class="sourceLine" id="cb28-61" data-line-number="61"></a>
<a class="sourceLine" id="cb28-62" data-line-number="62">  ComplexHeatmap<span class="op">::</span><span class="kw">decorate_heatmap_body</span>(<span class="st">&quot;ploidy&quot;</span>, {</a>
<a class="sourceLine" id="cb28-63" data-line-number="63">    <span class="kw">grid.polyline</span>(</a>
<a class="sourceLine" id="cb28-64" data-line-number="64">      <span class="dt">x =</span> abline_x,</a>
<a class="sourceLine" id="cb28-65" data-line-number="65">      <span class="dt">y =</span> abline_y,</a>
<a class="sourceLine" id="cb28-66" data-line-number="66">      <span class="dt">id =</span> abline_ids,</a>
<a class="sourceLine" id="cb28-67" data-line-number="67">      <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">lwd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb28-68" data-line-number="68">  })</a>
<a class="sourceLine" id="cb28-69" data-line-number="69">}</a></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">gr &lt;-<span class="st"> </span>cn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(chr, start, end, state, cell_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> cell_id, <span class="dt">values_from =</span> state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="st">  </span>GenomicRanges<span class="op">::</span><span class="kw">makeGRangesFromDataFrame</span>(<span class="dt">keep.extra.columns=</span><span class="ot">TRUE</span>,<span class="dt">ignore.strand=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb29-5" data-line-number="5"></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="kw">plot_cluster_heatmap</span>(gr, clust)</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>We can also merge cell copy number data by cluster to show aggregate cluster level copy number.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">clust.df &lt;-<span class="st"> </span><span class="kw">enframe</span>(clust.kmeans<span class="op">$</span>cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">cell_id =</span> name, <span class="dt">cluster =</span> value)</a>
<a class="sourceLine" id="cb30-3" data-line-number="3"></a>
<a class="sourceLine" id="cb30-4" data-line-number="4">clust.sizes &lt;-<span class="st"> </span><span class="kw">enframe</span>(<span class="kw">table</span>(clust.df<span class="op">$</span>cluster)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">cell_id =</span> name, <span class="dt">size =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(size <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb30-7" data-line-number="7"></a>
<a class="sourceLine" id="cb30-8" data-line-number="8">cn_clust &lt;-<span class="st"> </span>cn <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-9" data-line-number="9"><span class="st">  </span><span class="kw">inner_join</span>(clust.df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(chr, start, end, cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-11" data-line-number="11"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">copy =</span> <span class="kw">mean</span>(copy), <span class="dt">state =</span> <span class="kw">median</span>(state))</a></code></pre></div>
<pre><code>## Joining, by = &quot;cell_id&quot;</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;chr&#39;, &#39;start&#39;, &#39;end&#39;. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(cluster <span class="op">==</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot_profile</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 806 rows containing missing values (geom_point).</code></pre>
<p><img src="book_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(cluster <span class="op">==</span><span class="st"> </span><span class="dv">8</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot_profile</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 959 rows containing missing values (geom_point).</code></pre>
<p><img src="book_files/figure-html/unnamed-chunk-26-2.png" width="672" /></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(cluster <span class="op">==</span><span class="st"> </span><span class="dv">9</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot_profile</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 915 rows containing missing values (geom_point).</code></pre>
<p><img src="book_files/figure-html/unnamed-chunk-26-3.png" width="672" /></p>
<p>There appears to be a deletion on chromosome 5. Navigate here to see why:
<a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;lastVirtModeType=default&amp;lastVirtModeExtraState=&amp;virtModeType=default&amp;virtMode=0&amp;nonVirtPosition=&amp;position=chr5%3A67500000%2D72000002&amp;hgsid=1117136619_dGtW3EEOeJAIG6cYbSGFZwGwyLzb" class="uri">http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;lastVirtModeType=default&amp;lastVirtModeExtraState=&amp;virtModeType=default&amp;virtMode=0&amp;nonVirtPosition=&amp;position=chr5%3A67500000%2D72000002&amp;hgsid=1117136619_dGtW3EEOeJAIG6cYbSGFZwGwyLzb</a></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">subset.gr &lt;-<span class="st"> </span>cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(copy <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.2</span>, chr <span class="op">!=</span><span class="st"> &quot;Y&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">makeGRangesFromDataFrame</span>()</a>
<a class="sourceLine" id="cb39-2" data-line-number="2"></a>
<a class="sourceLine" id="cb39-3" data-line-number="3">knitr<span class="op">::</span><span class="kw">kable</span>(subset.gr, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">seqnames</th>
<th align="right">start</th>
<th align="right">end</th>
<th align="right">width</th>
<th align="left">strand</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69000001</td>
<td align="right">69500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">69500001</td>
<td align="right">70000000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">70000001</td>
<td align="right">70500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">70000001</td>
<td align="right">70500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">70000001</td>
<td align="right">70500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">70000001</td>
<td align="right">70500000</td>
<td align="right">5e+05</td>
<td align="left">*</td>
</tr>
</tbody>
</table>
</div>
<div id="subclonal-gene-amplification" class="section level2">
<h2><span class="header-section-number">2.6</span> Subclonal Gene Amplification</h2>
<p>Finally, lets look at the gene content of some of the high level amplifications. First read in a list of known oncogenic amplified genes from the cancer gene census. Read hg19 genes from <code>TxDb.Hsapiens.UCSC.hg19.knownGene</code> and be careful to rename chromosomes, ie “chr9” -&gt; “9”. Add gene symbols from <code>org.Hs.egSYMBOL</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">cencus.amps &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&#39;./Census_ampThu\ Apr\ 16\ 15_35_36\ 2020.csv&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">symbol =</span> <span class="st">`</span><span class="dt">Gene Symbol</span><span class="st">`</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   `Gene Symbol` = col_character(),
##   Name = col_character(),
##   `Entrez GeneId` = col_double(),
##   `Genome Location` = col_character(),
##   Tier = col_double(),
##   `Tumour Types(Somatic)` = col_character(),
##   Synonyms = col_character()
## )</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="co"># read human genes, normalize chromosome names</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2">human.genes &lt;-<span class="st"> </span><span class="kw">genes</span>(TxDb.Hsapiens.UCSC.hg19.knownGene)</a></code></pre></div>
<pre><code>##   403 genes were dropped because they have exons located on both strands of the same reference sequence or on
##   more than one reference sequence, so cannot be represented by a single genomic range.
##   Use &#39;single.strand.genes.only=FALSE&#39; to get all the genes in a GRangesList object, or use suppressMessages()
##   to suppress this message.</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">human.genes &lt;-<span class="st"> </span><span class="kw">renameSeqlevels</span>(human.genes, <span class="kw">sub</span>(<span class="st">&quot;chr&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">seqlevels</span>(human.genes)))</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="co"># add gene symbol from org.Hs.egSYMBOL</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">GenomicRanges<span class="op">::</span><span class="kw">mcols</span>(human.genes) &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">gene_id=</span>human.genes<span class="op">$</span>gene_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">tibble</span>(<span class="kw">as.data.frame</span>(org.Hs.egSYMBOL)))</a></code></pre></div>
<pre><code>## Joining, by = &quot;gene_id&quot;</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co"># subset by cancer gene cencus amps</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2">cencus.amps.genes &lt;-<span class="st"> </span>human.genes[(<span class="kw">elementMetadata</span>(human.genes)[,<span class="st">&#39;symbol&#39;</span>] <span class="op">%in%</span><span class="st"> </span>cencus.amps<span class="op">$</span>symbol)]</a></code></pre></div>
<p>Filter copy number for high level events, then subset by overlap with gene regions. The SOX2 gene is amplified.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1">subset.gr &lt;-<span class="st"> </span>cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(copy <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">makeGRangesFromDataFrame</span>(<span class="dt">keep.extra.columns=</span><span class="ot">TRUE</span>,<span class="dt">ignore.strand=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb47-2" data-line-number="2">subset.genes &lt;-<span class="st"> </span><span class="kw">subsetByOverlaps</span>(cencus.amps.genes, subset.gr)</a>
<a class="sourceLine" id="cb47-3" data-line-number="3"></a>
<a class="sourceLine" id="cb47-4" data-line-number="4">knitr<span class="op">::</span><span class="kw">kable</span>(subset.genes, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">seqnames</th>
<th align="right">start</th>
<th align="right">end</th>
<th align="right">width</th>
<th align="left">strand</th>
<th align="left">gene_id</th>
<th align="left">symbol</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="right">181429712</td>
<td align="right">181432223</td>
<td align="right">2512</td>
<td align="left">+</td>
<td align="left">6657</td>
<td align="left">SOX2</td>
</tr>
</tbody>
</table>
<p>Overlapping the SOX2 region with all cluster copy number we find that SOX2 is subclonally amplified.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r codeblock"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">all.gr &lt;-<span class="st"> </span>cn_clust <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">makeGRangesFromDataFrame</span>(<span class="dt">keep.extra.columns=</span><span class="ot">TRUE</span>,<span class="dt">ignore.strand=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="kw">subsetByOverlaps</span>(all.gr, subset.genes) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-3" data-line-number="3"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">factor</span>(cluster), <span class="dt">y=</span>copy))</a></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="targeted-snv-sequencing-of-an-all-sample.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["book.pdf", "book.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
